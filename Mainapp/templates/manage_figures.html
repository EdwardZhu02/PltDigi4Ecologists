{% extends 'master.html' %}

{% block title %}Manage Figures{% endblock %}

{% block content %}
<div class="container">
    <h2>Manage</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Preview</th>
                <th>Note</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for figure in figures %}
            <tr id="row-{{ figure.id }}">
                <td>{{ figure.id }}</td>
                <td><img src="/uploaded_images/{{ figure.image }}" alt="Figure Preview" style="max-width: 100px; max-height: 100px;"></td>
                <td>
                    <input type="text" id="note-{{ figure.id }}" value="{{ figure.note|default:'' }}" class="form-control mb-2" placeholder="Add Note">
                    <select id="category-{{ figure.id }}" class="form-select mb-2" onchange="saveChanges({{ figure.id }})">
                        <option value="" {% if not figure.category %}selected{% endif %}>Select Category</option>
                        <option value="scatterplot" {% if figure.category == 'scatterplot' %}selected{% endif %}>Scatterplot</option>
                        <option value="barplot" {% if figure.category == 'barplot' %}selected{% endif %}>Barplot</option>
                        <!-- More types -->
                    </select>
                </td>
                <td>
                    <a class="btn btn-primary" href="#" onclick="validateAndAnalyze({{ figure.id }})">Analyze</a>
                    <button class="btn btn-primary me-2" onclick="saveChanges({{ figure.id }})">Save Changes</button>
                    <button class="btn btn-danger" onclick="deleteFigure({{ figure.id }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function saveChanges(figureId) {
        const note = document.getElementById(`note-${figureId}`).value;
        const category = document.getElementById(`category-${figureId}`).value;

        fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                figure_id: figureId,
                note: note,
                category: category
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    function validateAndAnalyze(figureId) {
        const category = document.getElementById(`category-${figureId}`).value;
        if (!category) {
            alert('Please select a category before analyzing.');
            return;
        }
        window.location.href = `/interactive/${figureId}`;
    }

    function deleteFigure(figureId) {
        const confirmation = prompt('Type DELETE to confirm deletion of this figure and its analysis:');
        if (confirmation !== 'DELETE') {
            alert('Deletion cancelled.');
            return;
        }

        fetch("", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ delete_id: figureId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById(`row-${figureId}`).remove();
                alert('Figure and its analysis have been deleted successfully.');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
